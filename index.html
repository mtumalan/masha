<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M.A.S.H.A.</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root{
      --bg:#0b0e14; --ink:#e6e8ef; --muted:#9aa3b2; --panel:#111521; --border:#1e2636;
      --good:#1fb970; --bad:#e0526b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}

    .cal-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:12px}
    .cal-title{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .cal-title h2{margin:0;font-size:15px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #2a3244;border-radius:999px;background:#0d111a;font-size:12px;color:var(--ink)}
    .badge.positive{border-color:var(--good);color:var(--good)}
    .badge.negative{border-color:var(--bad);color:var(--bad)}
    button{background:#0d111a;color:var(--ink);border:1px solid #2a3244;border-radius:10px;padding:8px 10px;cursor:pointer}
    button:hover{background:#232b3b}

    .seg{display:inline-flex;border:1px solid #2a3244;border-radius:10px;overflow:hidden}
    .seg button{padding:6px 10px;border:0;background:#0d111a}
    .seg button.active{background:#1a2234;border-left:1px solid #2a3244;border-right:1px solid #2a3244}

    .cal-scroll{overflow:auto; -webkit-overflow-scrolling:touch}
    .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(90px,1fr));gap:8px;min-width:630px}
    .cal-dow{font-size:11px;color:var(--muted);text-align:center;padding:6px 0;position:sticky;top:0;background:var(--panel);z-index:1}

    .day{background:#1a2234;border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;aspect-ratio:1/1}
    .day.other{opacity:.35}
    .day .n{font-size:12px;color:var(--muted)}
    .day .u{margin-top:auto;font-weight:700}

    @media (max-width: 900px){
      .wrap{padding:0 12px}
      .cal-grid{grid-template-columns:repeat(7,minmax(70px,1fr));gap:6px;min-width:490px}
      .day{aspect-ratio:1/1;}
    }
    @media (max-width: 600px){
      .cal-top{flex-direction:column;align-items:flex-start}
      .cal-grid{grid-template-columns:repeat(7,minmax(56px,1fr));gap:5px;min-width:392px}
      .day{padding:8px;}
      .day .n{font-size:11px}
      .day .u{font-size:12px}
      h1{font-size:16px}
      .cal-title h2{font-size:14px}
      .badge{font-size:11px;padding:5px 8px}
      button{padding:6px 8px}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>M.A.S.H.A.</h1>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span id="monthUnits" class="badge">Mes: — u</span>
        <span id="monthTrades" class="badge">—</span>
        <div class="seg" id="modeSeg">
          <button data-mode="trade" class="active">Por trade</button>
          <button data-mode="hour">Por hora</button>
        </div>
      </div>
    </header>

    <section class="panel">
      <div class="cal-top">
        <div class="cal-title">
          <button id="prevMonth">◀</button>
          <h2 id="calTitle">—</h2>
          <button id="nextMonth">▶</button>
        </div>
      </div>
      <div class="cal-scroll"><div class="cal-grid" id="calGrid">
        <div class="cal-dow">Lun</div>
        <div class="cal-dow">Mar</div>
        <div class="cal-dow">Mié</div>
        <div class="cal-dow">Jue</div>
        <div class="cal-dow">Vie</div>
        <div class="cal-dow">Sáb</div>
        <div class="cal-dow">Dom</div>
      </div></div>
    </section>

    <div class="panel" style="padding:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; width:100%; margin-top:8px;">
      <span class="badge">Bank (MXN)</span>
      <input id="bankInput" type="number" inputmode="numeric" min="0" step="100"
            value="0"
            style="background:#0d111a;color:var(--ink);border:1px solid #2a3244;border-radius:10px;padding:8px 10px;max-width:180px" />
      <span id="clientPayout" class="badge">Payout mes: — MXN</span>
    </div>
  </div>

<script>
// ===== Config (replica Python) =====
const CSV_PATH = 'data/results.csv';

// Python params
const COINS_DEFAULT = ["BTCUSDT","XRPUSDT","ETHUSDT"];
const TH = {
  "BTCUSDT": 0.51599,
  "ETHUSDT": 0.509294,
  "XRPUSDT": 0.50813,
};

const UNIT     = 50;     // USD por unidad (stake base)
const PROFIT_F = 0.885;  // payout

// Stake rules (prioridad: fecha exacta > weekday)
const STAKE_MULT_BY_WEEKDAY = {
  "Wednesday": 1.5,
  "Saturday":  2.25,
  // "Thursday": 0.0,  // <-- YA NO: el apagado ahora depende de fecha
};
const STAKE_MULT_BY_DATE = {};
const DEFAULT_STAKE_MULT = 1.0;

// Thursday OFF a partir de esta fecha (UTC)
const THU_OFF_START_UTC = "2026-03-01"; // YYYY-MM-DD

// UI helpers
const $$=(s,r=document)=>r.querySelector(s);
const fmtNum=(n)=> new Intl.NumberFormat('es-MX',{maximumFractionDigits:2}).format(n);

// ===== Cliente payout =====
// MXN por unidad por cada 10k MXN
const CLIENT_MXN_PER_UNIT_PER_10K = 70;

function getBankMXN(){
  const el = $$('#bankInput');
  if(!el) return 0;
  const v = Number(el.value);
  return Number.isFinite(v) && v >= 0 ? v : 0;
}

// >>> CAMBIO CLAVE: ahora SÍ muestra pérdida cuando el mes es negativo
// (ya no clamp a 0)
function clientPayoutMXN(units, bankMXN){
  const scale = bankMXN / 10000.0;
  return units * CLIENT_MXN_PER_UNIT_PER_10K * scale;
}

function updateClientPayoutBadge(monthUnits){
  const el = $$('#clientPayout');
  if(!el) return;

  const bankMXN = getBankMXN();
  const payout  = clientPayoutMXN(monthUnits, bankMXN);

  const sign = payout > 0 ? '+' : '';
  el.textContent = `Payout mes: ${sign}${new Intl.NumberFormat('es-MX',{maximumFractionDigits:0}).format(payout)} MXN`;

  el.classList.toggle('positive', payout > 0);
  el.classList.toggle('negative', payout < 0);
}

let RAW=[];
let ROWS=[];
let CAL_CURRENT=null;
let MODE='trade';

// ---------- Parsing / utils ----------
function toNumber(x){
  if(x===null||x===undefined||x==='') return null;
  if(typeof x === 'string'){
    const t=x.trim().toLowerCase();
    if(t==='-inf'||t==='inf'||t==='infinity'||t==='-infinity'||t==='nan') return null;
  }
  const n=Number(x);
  return Number.isFinite(n)? n : null;
}

function parseTsAsUTC(x){
  if(x == null) return new Date(NaN);
  if(typeof x === 'number') return new Date(x);
  const s = String(x).trim();
  if(/[zZ]|[+\-]\d{2}:?\d{2}$/.test(s)) return new Date(s);
  const s2 = s.replace(' ', 'T');
  return new Date(s2 + 'Z');
}

function detectDateCol(cols){
  const guess=['timestamp','ts','date','datetime'];
  const lower=cols.map(c=>c.toLowerCase());
  for(const g of guess){
    const idx=lower.indexOf(g);
    if(idx!==-1) return cols[idx];
  }
  return cols[0];
}

function listCoinsFromHeaders(headers){
  const coins=new Set();
  for(const h of headers){
    if(h.startsWith('prob_up_')) coins.add(h.slice('prob_up_'.length));
    if(h.startsWith('prob_down_')) coins.add(h.slice('prob_down_'.length));
    if(h.startsWith('actual_')) coins.add(h.slice('actual_'.length));
    if(h.startsWith('signal_')) coins.add(h.slice('signal_'.length));
  }
  const arr=[...coins].sort();
  return arr.length ? arr : COINS_DEFAULT.slice();
}

function ymdUTC(d){
  return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()))
    .toISOString().slice(0,10);
}

function weekdayNameUTC(d){
  return new Intl.DateTimeFormat('en-US',{weekday:'long',timeZone:'UTC'}).format(d);
}

function stakeMultiplierForTsUTC(d){
  const dstr = ymdUTC(d);

  // prioridad: fecha exacta
  if(Object.prototype.hasOwnProperty.call(STAKE_MULT_BY_DATE, dstr)){
    return Number(STAKE_MULT_BY_DATE[dstr]);
  }

  const wd = weekdayNameUTC(d);

  // Thursday OFF solo desde 2026-02-01 (UTC) en adelante
  // (comparación lexicográfica segura para YYYY-MM-DD)
  if(wd === "Thursday" && dstr >= THU_OFF_START_UTC){
    return 0.0;
  }

  return Number(STAKE_MULT_BY_WEEKDAY[wd] ?? DEFAULT_STAKE_MULT);
}

function isDroppedMondayFirstHourUTC(d){
  return (d.getUTCDay() === 1) && (d.getUTCHours() === 0);
}

function computeSignal(probUp, probDown, th){
  if(probUp >= th && probUp >= probDown) return 1;
  if(probDown >= th && probDown >= probUp) return -1;
  return 0;
}

function buildRowsLikePython(rawRows, dateCol){
  if(!rawRows?.length) return [];

  const headers = Object.keys(rawRows[0]);
  const coins = listCoinsFromHeaders(headers);

  const tmp = [];
  for(const r of rawRows){
    const t = parseTsAsUTC(r[dateCol]);
    if(isNaN(t)) continue;
    if(isDroppedMondayFirstHourUTC(t)) continue;

    const stake_mult = stakeMultiplierForTsUTC(t);

    let pnl_total_usd = 0;
    let trades = 0;

    for(const c of coins){
      const puRaw = toNumber(r['prob_up_'+c]);
      const pdRaw = toNumber(r['prob_down_'+c]);
      const probUp   = (puRaw === null ? -Infinity : puRaw);
      const probDown = (pdRaw === null ? -Infinity : pdRaw);

      const actRaw = toNumber(r['actual_'+c]);
      const actual = (actRaw === null ? 0 : (actRaw|0));

      let signal;
      if((('prob_up_'+c) in r || ('prob_down_'+c) in r) && (TH[c] !== undefined)){
        signal = computeSignal(probUp, probDown, TH[c]);
      } else {
        const sigRaw = toNumber(r['signal_'+c]);
        signal = (sigRaw === null ? 0 : (sigRaw|0));
        if(signal !== -1 && signal !== 0 && signal !== 1) signal = 0;
      }

      const hit = (signal !== 0) && (signal === actual);

      const win_amt  = UNIT * stake_mult * PROFIT_F;
      const lose_amt = -UNIT * stake_mult;

      const pnl_usd = (signal === 0) ? 0 : (hit ? win_amt : lose_amt);

      pnl_total_usd += pnl_usd;
      if(signal !== 0) trades += 1;
    }

    const u_total = pnl_total_usd / UNIT;

    const hourISO = new Date(Date.UTC(
      t.getUTCFullYear(), t.getUTCMonth(), t.getUTCDate(), t.getUTCHours()
    )).toISOString();

    tmp.push({ tsISO: t.toISOString(), hourISO, u_total, trades });
  }

  // cutoff común
  const lastByCoin = {};
  for(const c of coins) lastByCoin[c] = null;

  for(const r of rawRows){
    const t = parseTsAsUTC(r[dateCol]);
    if(isNaN(t)) continue;
    if(isDroppedMondayFirstHourUTC(t)) continue;

    for(const c of coins){
      const pu = toNumber(r['prob_up_'+c]);
      const pd = toNumber(r['prob_down_'+c]);
      const hasProbCols = (('prob_up_'+c) in r) || (('prob_down_'+c) in r);

      let real = false;
      if(hasProbCols){
        const puF = (pu === null ? -Infinity : pu);
        const pdF = (pd === null ? -Infinity : pd);
        real = Number.isFinite(puF) || Number.isFinite(pdF);
      } else {
        const act = toNumber(r['actual_'+c]) ?? 0;
        const sig = toNumber(r['signal_'+c]) ?? 0;
        real = (act !== 0) || (sig !== 0);
      }

      if(real){
        if(lastByCoin[c] === null || t > lastByCoin[c]) lastByCoin[c] = t;
      }
    }
  }

  const lastVals = Object.values(lastByCoin).filter(d => d instanceof Date && !isNaN(d));
  const cutoffCommon = lastVals.length ? new Date(Math.min(...lastVals.map(d=>d.getTime()))) : null;

  const filtered = cutoffCommon
    ? tmp.filter(o => new Date(o.tsISO).getTime() <= cutoffCommon.getTime())
    : tmp;

  filtered.sort((a,b)=> (a.tsISO < b.tsISO ? -1 : a.tsISO > b.tsISO ? 1 : 0));
  return filtered;
}

function summarizeByDay_Hours(rows){
  const byDay=new Map();
  for(const r of rows){
    const d=new Date(r.tsISO);
    const key=new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).toISOString().slice(0,10);
    const o=byDay.get(key)||{u:0,hours:0,trades:0};
    o.u += r.u_total;
    o.hours += 1;
    o.trades += r.trades;
    byDay.set(key,o);
  }
  return byDay;
}

function renderCalendar(){
  if(!CAL_CURRENT){
    const grid=$$('#calGrid');
    if(grid) grid.innerHTML='';
    updateClientPayoutBadge(0);
    return 0;
  }

  const year=CAL_CURRENT.getUTCFullYear(), month=CAL_CURRENT.getUTCMonth();
  const first=new Date(Date.UTC(year,month,1));
  const dow=first.getUTCDay();
  const offset=(dow===0?-6:1-dow);
  const start=new Date(Date.UTC(year,month,1+offset));

  const byDay = summarizeByDay_Hours(ROWS);

  const titleEl = $$('#calTitle');
  if(titleEl){
    titleEl.textContent=new Intl.DateTimeFormat('es-MX',{month:'long',year:'numeric',timeZone:'UTC'}).format(first);
  }

  let monthUnits=0, monthCount=0;
  const rightLabel = (MODE === 'trade') ? 'Trades' : 'Horas';

  const grid=$$('#calGrid');
  if(!grid){
    updateClientPayoutBadge(0);
    return 0;
  }

  grid.innerHTML=`<div class="cal-dow">Lun</div><div class="cal-dow">Mar</div><div class="cal-dow">Mié</div><div class="cal-dow">Jue</div><div class="cal-dow">Vie</div><div class="cal-dow">Sáb</div><div class="cal-dow">Dom</div>`;

  const daysInMonth=new Date(Date.UTC(year,month+1,0)).getUTCDate();
  const vals=[];
  for(let d=1; d<=daysInMonth; d++){
    const key=new Date(Date.UTC(year,month,d)).toISOString().slice(0,10);
    const rec=byDay.get(key);
    vals.push(Math.abs(rec?.u||0));
  }
  const maxAbs=Math.max(0,...vals);

  for(let i=0;i<42;i++){
    const d=new Date(Date.UTC(start.getUTCFullYear(),start.getUTCMonth(),start.getUTCDate()+i));
    const key=d.toISOString().slice(0,10);
    const inMonth=d.getUTCMonth()===month;

    const rec=byDay.get(key) || {u:0,hours:0,trades:0};

    if(inMonth){
      monthUnits += rec.u;
      monthCount += (MODE === 'trade') ? rec.trades : rec.hours;
    }

    const u=rec.u;
    const alpha=maxAbs>0? (0.18+0.72*Math.min(1,Math.abs(u)/maxAbs)) : 0;

    let bg, border;
    if(u>0){ bg=`rgba(31,185,112,${alpha})`; border='rgba(31,185,112,.55)'; }
    else if(u<0){ bg=`rgba(224,82,107,${alpha})`; border='rgba(224,82,107,.55)'; }
    else { bg='#1a2234'; border='var(--border)'; }

    const div=document.createElement('div');
    div.className='day'+(inMonth?'':' other');
    div.style.background = u===0 ? bg : `linear-gradient(180deg, ${bg}, rgba(0,0,0,.08))`;
    div.style.borderColor = border;
    div.innerHTML = `<div class="n">${d.getUTCDate()}</div><div class="u">${u>0? '+'+fmtNum(u): (u<0? fmtNum(u): '—')} u</div>`;
    grid.appendChild(div);
  }

  const badge=$$('#monthUnits');
  if(badge){
    badge.textContent = `Mes: ${monthUnits>0? '+'+fmtNum(monthUnits): fmtNum(monthUnits)} u`;
    badge.classList.toggle('positive', monthUnits>0);
    badge.classList.toggle('negative', monthUnits<0);
  }

  const mt=$$('#monthTrades');
  if(mt){
    mt.textContent = `${rightLabel}: ${new Intl.NumberFormat('es-MX').format(monthCount)}`;
  }

  updateClientPayoutBadge(monthUnits);
  return monthUnits;
}

async function loadCSV(){
  return new Promise((res,rej)=>{
    Papa.parse(CSV_PATH,{
      header:true, dynamicTyping:true, download:true, skipEmptyLines:true,
      complete:(o)=>res(o.data), error:(e)=>rej(e)
    });
  });
}

(async()=>{
  try{
    RAW = await loadCSV();
    if(!RAW || !RAW.length) throw new Error('CSV vacío');

    const headers=Object.keys(RAW[0]);
    const dateCol = detectDateCol(headers);

    ROWS = buildRowsLikePython(RAW, dateCol);
    if(!ROWS.length) throw new Error('Sin filas útiles tras drop/cutoff');

    const dLast = new Date(ROWS[ROWS.length - 1].tsISO);
    CAL_CURRENT = new Date(Date.UTC(dLast.getUTCFullYear(), dLast.getUTCMonth(), 1));

    renderCalendar();
  }catch(e){
    console.error(e);
  }
})();

$$('#prevMonth')?.addEventListener('click', ()=>{
  if(!CAL_CURRENT) return;
  CAL_CURRENT = new Date(Date.UTC(CAL_CURRENT.getUTCFullYear(), CAL_CURRENT.getUTCMonth()-1, 1));
  renderCalendar();
});
$$('#nextMonth')?.addEventListener('click', ()=>{
  if(!CAL_CURRENT) return;
  CAL_CURRENT = new Date(Date.UTC(CAL_CURRENT.getUTCFullYear(), CAL_CURRENT.getUTCMonth()+1, 1));
  renderCalendar();
});

$$('#bankInput')?.addEventListener('input', ()=> renderCalendar());

document.querySelectorAll('#modeSeg button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#modeSeg button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    MODE = btn.dataset.mode;
    renderCalendar();
  });
});
</script>

</body>
</html>
